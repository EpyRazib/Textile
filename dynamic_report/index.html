<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Report Interface</title>
    <!-- Tailwind CSS CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet" onerror="console.error('Failed to load Tailwind CSS')">
    <!-- CDNs with error handling and fallbacks -->
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" onerror="console.error('Failed to load React')"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" onerror="console.error('Failed to load ReactDOM')"></script>
    <!-- Babel with fallback -->
    <script src="https://unpkg.com/@babel/standalone@7.25.6/babel.min.js" onerror="loadBabelFallback()"></script>
    <script>
        function loadBabelFallback() {
            console.error('Failed to load primary Babel CDN');
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/babel-standalone@7.22.5/babel.min.js';
            script.onerror = () => console.error('Failed to load fallback Babel CDN');
            document.head.appendChild(script);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/react-draggable@4.4.6/dist/react-draggable.min.js" onerror="console.error('Failed to load react-draggable')"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" onerror="console.error('Failed to load XLSX')"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" onerror="console.error('Failed to load jsPDF')"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js" onerror="console.error('Failed to load jsPDF-autotable')"></script>
</head>
<body>
    <div id="root" class="p-4"></div>
    <script type="text/babel">
        try {
            const { useState, useRef } = React;
            const { jsPDF } = window.jspdf;

            const sampleData = [
                { id: 1, name: "John Doe", age: 30, department: "Sales", hireDate: "2023-01-15", salary: 50000 },
                { id: 2, name: "Jane Smith", age: 25, department: "Marketing", hireDate: "2022-06-20", salary: 45000 },
                { id: 3, name: "Bob Johnson", age: 40, department: "IT", hireDate: "2021-03-10", salary: 60000 },
                { id: 4, name: "Alice Brown", age: 35, department: "HR", hireDate: "2020-09-05", salary: 55000 },
            ];

            const fieldConfig = {
                name: { label: "Name", type: "text", options: [...new Set(sampleData.map(item => item.name))] },
                age: { label: "Age", type: "number" },
                department: { label: "Department", type: "text", options: [...new Set(sampleData.map(item => item.department))] },
                hireDate: { label: "Hire Date", type: "date" },
                salary: { label: "Salary", type: "number" },
            };

            const App = () => {
                const [criteriaFields, setCriteriaFields] = useState([]);
                const [reportFields, setReportFields] = useState([]);
                const [filters, setFilters] = useState({});
                const [reportData, setReportData] = useState([]);
                const criteriaDropRef = useRef(null);
                const reportDropRef = useRef(null);

                const handleDragStart = (e, field) => {
                    e.dataTransfer.setData("field", field);
                };

                const handleCriteriaDrop = (e) => {
                    e.preventDefault();
                    const field = e.dataTransfer.getData("field");
                    if (field && !criteriaFields.includes(field) && !reportFields.includes(field)) {
                        setCriteriaFields([...criteriaFields, field]);
                    }
                };

                const handleReportDrop = (e) => {
                    e.preventDefault();
                    const field = e.dataTransfer.getData("field");
                    if (field && !reportFields.includes(field) && !criteriaFields.includes(field)) {
                        setReportFields([...reportFields, field]);
                    }
                };

                const allowDrop = (e) => {
                    e.preventDefault();
                };

                const removeCriteriaField = (field) => {
                    setCriteriaFields(criteriaFields.filter(f => f !== field));
                    setFilters(prev => {
                        const newFilters = { ...prev };
                        delete newFilters[field];
                        return newFilters;
                    });
                };

                const removeReportField = (field) => {
                    setReportFields(reportFields.filter(f => f !== field));
                };

                const handleFilterChange = (field, value) => {
                    setFilters(prev => ({ ...prev, [field]: value }));
                };

                const generateReport = () => {
                    let filteredData = [...sampleData];
                    
                    Object.keys(filters).forEach(field => {
                        const filter = filters[field];
                        const fieldType = fieldConfig[field].type;

                        filteredData = filteredData.filter(item => {
                            if (fieldType === 'text') {
                                return !filter || filter === '' || item[field] === filter;
                            } else if (fieldType === 'number') {
                                const [min, max] = filter || [0, Infinity];
                                return item[field] >= min && item[field] <= max;
                            } else if (fieldType === 'date') {
                                const [start, end] = filter || ['', ''];
                                const itemDate = new Date(item[field]);
                                const startDate = start ? new Date(start) : new Date(-8640000000000000);
                                const endDate = end ? new Date(end) : new Date(8640000000000000);
                                return itemDate >= startDate && itemDate <= endDate;
                            }
                            return true;
                        });
                    });

                    const selectedFields = reportFields.length > 0 ? reportFields : Object.keys(fieldConfig);
                    const mappedData = filteredData.map(item => {
                        const row = {};
                        selectedFields.forEach(field => {
                            row[field] = item[field];
                        });
                        return row;
                    });

                    setReportData(mappedData);
                };

                const exportToExcel = () => {
                    const ws = XLSX.utils.json_to_sheet(reportData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Report");
                    XLSX.writeFile(wb, "report.xlsx");
                };

                const exportToPDF = () => {
                    const doc = new jsPDF();
                    doc.setFontSize(12);
                    doc.text("Report", 20, 20);

                    const headers = reportFields.length > 0 ? reportFields : Object.keys(fieldConfig);
                    const tableData = reportData.map(row => headers.map(field => row[field] || ''));

                    doc.autoTable({
                        head: [headers.map(field => fieldConfig[field].label)],
                        body: tableData,
                        startY: 30,
                    });

                    doc.save("report.pdf");
                };

                const renderFilterInput = (field) => {
                    const config = fieldConfig[field];
                    if (config.type === 'text') {
                        return (
                            <select
                                className="border rounded p-1 w-48"
                                onChange={(e) => handleFilterChange(field, e.target.value)}
                            >
                                <option value="">Select {config.label}</option>
                                {config.options.map(option => (
                                    <option key={option} value={option}>{option}</option>
                                ))}
                            </select>
                        );
                    } else if (config.type === 'number') {
                        return (
                            <div className="flex space-x-2">
                                <input
                                    type="number"
                                    placeholder="Min"
                                    className="border rounded p-1 w-20"
                                    onChange={(e) => handleFilterChange(field, [
                                        e.target.value ? Number(e.target.value) : 0,
                                        filters[field]?.[1] || Infinity
                                    ])}
                                />
                                <input
                                    type="number"
                                    placeholder="Max"
                                    className="border rounded p-1 w-20"
                                    onChange={(e) => handleFilterChange(field, [
                                        filters[field]?.[0] || 0,
                                        e.target.value ? Number(e.target.value) : Infinity
                                    ])}
                                />
                            </div>
                        );
                    } else if (config.type === 'date') {
                        return (
                            <div className="flex space-x-2">
                                <input
                                    type="date"
                                    className="border rounded p-1"
                                    onChange={(e) => handleFilterChange(field, [
                                        e.target.value,
                                        filters[field]?.[1] || ''
                                    ])}
                                />
                                <input
                                    type="date"
                                    className="border rounded p-1"
                                    onChange={(e) => handleFilterChange(field, [
                                        filters[field]?.[0] || '',
                                        e.target.value
                                    ])}
                                />
                            </div>
                        );
                    }
                    return null;
                };

                return (
                    <div className="max-w-6xl mx-auto flex">
                        <div className="w-1/4 bg-gray-100 p-4 rounded-lg mr-4">
                            <h2 className="text-lg font-semibold mb-2">Available Fields</h2>
                            <div className="flex flex-col gap-2">
                                {Object.keys(fieldConfig).map(field => (
                                    (!criteriaFields.includes(field) && !reportFields.includes(field)) && (
                                        <div
                                            key={field}
                                            draggable
                                            onDragStart={(e) => handleDragStart(e, field)}
                                            className="bg-blue-500 text-white px-3 py-1 rounded cursor-move"
                                        >
                                            {fieldConfig[field].label}
                                        </div>
                                    )
                                ))}
                            </div>
                        </div>
                        <div className="w-3/4">
                            <h1 className="text-2xl font-bold mb-4">Dynamic Report Generator</h1>
                            <div
                                ref={criteriaDropRef}
                                onDrop={handleCriteriaDrop}
                                onDragOver={allowDrop}
                                className="mb-6 p-4 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300"
                            >
                                <h2 className="text-lg font-semibold mb-2">Criteria Fields</h2>
                                {criteriaFields.length === 0 && (
                                    <p className="text-gray-500">Drag and drop fields here</p>
                                )}
                                {criteriaFields.map(field => (
                                    <div key={field} className="flex items-center space-x-2 mb-2">
                                        <span className="w-24">{fieldConfig[field].label}:</span>
                                        {renderFilterInput(field)}
                                        <button
                                            className="text-red-500 text-sm"
                                            onClick={() => removeCriteriaField(field)}
                                        >
                                            Remove
                                        </button>
                                    </div>
                                ))}
                            </div>
                            <div
                                ref={reportDropRef}
                                onDrop={handleReportDrop}
                                onDragOver={allowDrop}
                                className="mb-6 p-4 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300"
                            >
                                <h2 className="text-lg font-semibold mb-2">Report Fields</h2>
                                {reportFields.length === 0 && (
                                    <p className="text-gray-500">Drag and drop fields here</p>
                                )}
                                <div className="flex flex-wrap gap-2">
                                    {reportFields.map(field => (
                                        <div key={field} className="flex items-center space-x-2">
                                            <span>{fieldConfig[field].label}</span>
                                            <button
                                                className="text-red-500 text-sm"
                                                onClick={() => removeReportField(field)}
                                            >
                                                Remove
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <button
                                className="bg-purple-500 text-white px-6 py-2 rounded mb-6"
                                onClick={generateReport}
                            >
                                Generate Report
                            </button>
                            {reportData.length > 0 && (
                                <div>
                                    <div className="mb-4 flex justify-start">
                                        <button
                                            className="bg-blue-500 text-white px-4 py-2 rounded mr-2"
                                            onClick={exportToExcel}
                                        >
                                            Export to Excel
                                        </button>
                                        <button
                                            className="bg-blue-500 text-white px-4 py-2 rounded"
                                            onClick={exportToPDF}
                                        >
                                            Export to PDF
                                        </button>
                                    </div>
                                    <table className="w-full border-collapse border border-gray-300">
                                        <thead>
                                            <tr className="bg-gray-200">
                                                {(reportFields.length > 0 ? reportFields : Object.keys(fieldConfig)).map(field => (
                                                    <th key={field} className="border border-gray-300 p-2">
                                                        {fieldConfig[field].label}
                                                    </th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {reportData.map((row, index) => (
                                                <tr key={index}>
                                                    {(reportFields.length > 0 ? reportFields : Object.keys(fieldConfig)).map(field => (
                                                        <td key={field} className="border border-gray-300 p-2">
                                                            {row[field]}
                                                        </td>
                                                    ))}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            ReactDOM.render(<App />, document.getElementById('root'));
        } catch (e) {
            console.error('Error rendering application:', e);
            document.getElementById('root').innerHTML = '<h1 class="text-red-500 text-center">Error loading application. Please check console for details.</h1>';
        }
    </script>
</body>
</html>
